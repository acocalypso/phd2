name: Build Debian arm64 package

on:
  workflow_dispatch:

jobs:
  debian-arm64:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies (host arm64)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl git software-properties-common \
            build-essential packaging-dev debhelper devscripts equivs fakeroot \
            cmake ninja-build pkg-config

          # INDI >= 2.0 is required; use official PPA to satisfy version
          sudo add-apt-repository -y ppa:mutlaqja/ppa
          sudo apt-get update

          sudo apt-get install -y --no-install-recommends \
            wx-common wx3.2-i18n libwxgtk3.2-dev \
            libindi-dev libnova-dev gettext zlib1g-dev libx11-dev \
            libcurl4-gnutls-dev libopencv-dev libeigen3-dev libgtest-dev

          sudo mk-build-deps --install --remove \
            --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y" \
            debian/control

      - name: Build Debian package
        run: |
          set -euo pipefail
          export DEB_BUILD_OPTIONS="nocheck parallel=$(nproc)"
          dpkg-buildpackage -b -us -uc -a arm64

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          find .. -maxdepth 1 -name "*.deb" -exec cp {} artifacts/ \;

      - name: List artifacts (debug)
        run: ls -l artifacts || true

      - name: Compute tag and name
        id: tag
        run: |
          set -euo pipefail
          version=$(sed -n '1s/^.*(\([^)]*\)).*/\1/p' debian/changelog)
          ts=$(date -u +%Y%m%d-%H%M%S)
          tag="v${version}-${ts}"
          echo "tag_name=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=$tag" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: ${{ steps.tag.outputs.release_name }}
          files: artifacts/*.deb
