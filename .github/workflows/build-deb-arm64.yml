name: Build Debian arm64 package

on:
  workflow_dispatch:

jobs:
  debian-arm64:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies (host arm64)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl git software-properties-common \
            build-essential packaging-dev debhelper devscripts equivs fakeroot \
            cmake ninja-build pkg-config

          # INDI >= 2.0 is required; use official PPA to satisfy version
          sudo add-apt-repository -y ppa:mutlaqja/ppa
          sudo apt-get update

          sudo apt-get install -y --no-install-recommends \
            wx-common wx3.2-i18n libwxgtk3.2-dev \
            libindi-dev libnova-dev gettext zlib1g-dev libx11-dev \
            libcurl4-gnutls-dev libeigen3-dev libgtest-dev libopencv-dev \
            libjpeg-dev libpng-dev libtiff-dev libavcodec-dev libavformat-dev \
            libswscale-dev libavutil-dev libgtk-3-dev libv4l-dev libdc1394-22-dev

          sudo mk-build-deps --install --remove \
            --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y" \
            debian/control

      - name: Build OpenCV 4.11.0 (host arm64)
        run: |
          set -euo pipefail
          OPENCV_VERSION=4.11.0
          curl -L "https://github.com/opencv/opencv/archive/refs/tags/${OPENCV_VERSION}.tar.gz" -o opencv-${OPENCV_VERSION}.tar.gz
          tar -xf opencv-${OPENCV_VERSION}.tar.gz
          cmake -S opencv-${OPENCV_VERSION} -B opencv-${OPENCV_VERSION}/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DBUILD_LIST=core,imgproc,highgui,videoio,imgcodecs \
            -DBUILD_TESTS=OFF -DBUILD_PERF_TESTS=OFF -DBUILD_EXAMPLES=OFF \
            -DWITH_FFMPEG=ON -DWITH_GSTREAMER=ON
          cmake --build opencv-${OPENCV_VERSION}/build --parallel
          sudo cmake --install opencv-${OPENCV_VERSION}/build
          sudo ldconfig

      - name: Build Debian package
        run: |
          set -euo pipefail
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          export LD_LIBRARY_PATH="/usr/local/lib:${LD_LIBRARY_PATH:-}"
          export CMAKE_PREFIX_PATH="/usr/local:${CMAKE_PREFIX_PATH:-}"
          export OpenCV_DIR="/usr/local/lib/cmake/opencv4"
          export DEB_BUILD_OPTIONS="nocheck parallel=$(nproc)"
          dpkg-buildpackage -b -us -uc -a arm64

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          find .. -maxdepth 1 -name "*.deb" -exec cp {} artifacts/ \;

      - name: List artifacts (debug)
        run: ls -l artifacts || true

      - name: Compute tag and name
        id: tag
        run: |
          set -euo pipefail
          version=$(sed -n '1s/^.*(\([^)]*\)).*/\1/p' debian/changelog)
          ts=$(date -u +%Y%m%d-%H%M%S)
          tag="v${version}-${ts}"
          echo "tag_name=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=$tag" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: ${{ steps.tag.outputs.release_name }}
          files: artifacts/*.deb
