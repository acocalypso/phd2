name: Build Debian arm64 package

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:

jobs:
  debian-arm64:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU for arm64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build .deb inside Debian trixie arm64 container
        run: |
          set -euo pipefail
          docker run --rm --platform linux/arm64 \
            -v "${PWD}:/workspace" \
            -w /workspace \
            debian:trixie \
            bash -s <<'EOF'
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive

          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl git \
            build-essential packaging-dev debhelper devscripts equivs fakeroot \
            cmake ninja-build pkg-config \
            wx-common wx3.2-i18n libwxgtk3.2-dev \
            libindi-dev libnova-dev gettext zlib1g-dev libx11-dev \
            libcurl4-gnutls-dev libopencv-dev libeigen3-dev libgtest-dev

          mk-build-deps --install --remove \
            --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y" \
            debian/control

          export DEB_BUILD_OPTIONS="nocheck parallel=$(nproc)"
          dpkg-buildpackage -b -us -uc -a arm64

          mkdir -p /workspace/artifacts
          find .. -maxdepth 1 -name "*.deb" -exec cp {} /workspace/artifacts/ \;
          EOF

      - name: List artifacts (debug)
        run: ls -l artifacts || true

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: phd2-debian-arm64
          path: artifacts/*.deb
