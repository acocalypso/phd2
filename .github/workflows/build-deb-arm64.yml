name: Build Debian arm64 package

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:

jobs:
  debian-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies (host arm64)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl git \
            build-essential packaging-dev debhelper devscripts equivs fakeroot \
            cmake ninja-build pkg-config \
            wx-common wx3.2-i18n libwxgtk3.2-dev \
            libindi-dev libnova-dev gettext zlib1g-dev libx11-dev \
            libcurl4-gnutls-dev libopencv-dev libeigen3-dev libgtest-dev

          sudo mk-build-deps --install --remove \
            --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y" \
            debian/control

      - name: Build Debian package
        run: |
          set -euo pipefail
          export DEB_BUILD_OPTIONS="nocheck parallel=$(nproc)"
          dpkg-buildpackage -b -us -uc -a arm64

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          find .. -maxdepth 1 -name "*.deb" -exec cp {} artifacts/ \;

      - name: List artifacts (debug)
        run: ls -l artifacts || true

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: phd2-debian-arm64
          path: artifacts/*.deb
