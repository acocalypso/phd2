name: Build Debian arm64 package

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name for release (leave empty to auto-generate)"
        required: false
      release_name:
        description: "Release title"
        required: false
      prerelease:
        description: "Mark as prerelease"
        required: false
        default: "true"
  push:
    branches: [ master ]
  pull_request:

jobs:
  debian-arm64:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies (host arm64)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl git software-properties-common \
            build-essential packaging-dev debhelper devscripts equivs fakeroot \
            cmake ninja-build pkg-config

          # INDI >= 2.0 is required; use official PPA to satisfy version
          sudo add-apt-repository -y ppa:mutlaqja/ppa
          sudo apt-get update

          sudo apt-get install -y --no-install-recommends \
            wx-common wx3.2-i18n libwxgtk3.2-dev \
            libindi-dev libnova-dev gettext zlib1g-dev libx11-dev \
            libcurl4-gnutls-dev libopencv-dev libeigen3-dev libgtest-dev

          sudo mk-build-deps --install --remove \
            --tool "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y" \
            debian/control

      - name: Build Debian package
        run: |
          set -euo pipefail
          export DEB_BUILD_OPTIONS="nocheck parallel=$(nproc)"
          dpkg-buildpackage -b -us -uc -a arm64

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          find .. -maxdepth 1 -name "*.deb" -exec cp {} artifacts/ \;

      - name: List artifacts (debug)
        run: ls -l artifacts || true

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: phd2-debian-arm64
          path: artifacts/*.deb

  release:
    needs: debian-arm64
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Compute tag and name
        id: tag
        run: |
          set -euo pipefail
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            tag="${{ github.event.inputs.tag }}"
          else
            ts=$(date -u +%Y%m%d-%H%M%S)
            tag="auto-${ts}-${GITHUB_SHA::7}"
          fi
          if [ -n "${{ github.event.inputs.release_name }}" ]; then
            relname="${{ github.event.inputs.release_name }}"
          else
            relname="$tag"
          fi
          echo "tag_name=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=$relname" >> "$GITHUB_OUTPUT"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: phd2-debian-arm64
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: ${{ steps.tag.outputs.release_name }}
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: dist/*.deb
